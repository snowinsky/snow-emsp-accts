<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.snow.emsp.accts.persistence.mapper.CardMapper">
    <insert id="insert" parameterType="cn.snow.emsp.accts.persistence.model.DbCard"
            useGeneratedKeys="true" keyProperty="card.id">
        INSERT INTO t_card (
        rfid_uid,
        rfid_visible_number,
        contract_id,
        account_id,
        status,
        create_at,
        last_updated)
        VALUES (#{card.rfidUid}, #{card.rfidVisibleNumber}, #{card.contractId}, #{card.accountId},
        #{card.status}, #{card.createAt},
        #{account.lastUpdated})
    </insert>
    <update id="updateStatus">
        update t_card
        set status = #{card.status},
        last_updated = #{card.lastUpdated}
        where id = #{card.id} and vers = #{oldVersion}
    </update>
    <update id="updateAccount">
        update t_card
        set account_id = COALESCE(#{card.accountId}, account_id),
        contract_id = COALESCE(#{card.contractId}, contract_id),
        last_updated = #{card.lastUpdated}
        where id = #{card.id} and vers = #{oldVersion}
    </update>
    <select id="selectByCardId" resultType="cn.snow.emsp.accts.persistence.model.DbCard">
        select id, rfid_uid as rfidUid, rfid_visible_number as rfidVisibleNumber, contract_id as contractId, account_id as accountId, status, create_at as createAt, last_updated as lastUpdated, vers
        from t_card
        where id = #{cardId} limit 1
    </select>
</mapper>